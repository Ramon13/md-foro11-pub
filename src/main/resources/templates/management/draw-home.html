<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org" layout:decorate="~{management/layout}">
  
  <body>
    <div layout:fragment="content">
      <form id="drawForm" class="multipleForm" method="get" th:object="${sessionDraw}">
        <!-- TELA 0 -->
        <div class="tab tab1" th:if="${!editMode}">
                      
          <h1>Novo Sorteio</h1>
          <h2>Configurações Gerais:</h2>
          
          <div>
            <label>Conselho de Justiça:</label><br/>
            
            <select id="councilSelect" class="app-select" th:field="*{justiceCouncil}">
              <option th:each="council : ${councils}" th:value="${council.id}" 
                th:text="${council.name}">
              </option>
            </select>
          </div>
          
          <div>
            <label>Força Armada:</label><br/>
            
            <select id="armySelect" class="app-select" th:field="*{army}">
              <option th:each="army : ${armies}" th:value="${army.id}" 
                th:text="${army.name}">
              </option>
            </select>
          </div>
          
          <div id="annualQuarter" th:if="${sessionDraw.councilType == T(br.com.javamoon.domain.draw.CouncilType).CPJ}">
            <label>Trimestre:</label><br/>
            <select id="quarterSelect" class="app-select" th:name="annualQuarter">
              <option th:each="quarter : ${quarters}" th:value="${quarter.toShortFormat()}" 
                th:text="${quarter.description}"
                th:selected="${quarter.getStartQuarterDate eq sessionDraw.annualQuarter.getStartQuarterDate}">
              </option>
            </select>
          </div>
          
          <div th:if="${sessionDraw.councilType == T(br.com.javamoon.domain.draw.CouncilType).CEJ}">
            <label>Nº do Processo:</label><br/>
            
            <span th:if="${#fields.hasErrors('processNumber')}" class="error" th:errors="*{processNumber}"></span>
            
            <input type="text" th:field="*{processNumber}" class="app-txtinput"
              th:classappend="${#fields.hasErrors('processNumber')} ? 'error' : ''"/>
          </div>
        </div>
        
        
        <!-- TELA 1 -->
        <div id="ranks" class="tab">
          <h1 th:text="${sessionDraw.justiceCouncil.name}"></h1>
          
          <h2>Seleção de postos:</h2>
          
          <div class="ranks" th:each="i : ${#numbers.sequence(1, sessionDraw.justiceCouncil.councilSize)}">
            <select class="app-select ranks" name="ranks">
              <option th:each="rank : ${ranksByArmy}" th:value="${rank.id}"
                th:selected="${
                                !#lists.isEmpty(sessionDraw.ranks) and 
                                i <= #lists.size(sessionDraw.ranks) and
                                rank.id eq sessionDraw.ranks[i - 1].id
                             }" 
                th:text="${rank.name}"></option>
            </select>
          </div>
        </div>
        
        
        
        <!-- TELA 2 -->
        <div class="tab" th:if="${!#lists.isEmpty(sessionDraw.soldiers)}">
          <h1>Conselho Especial de Justiça</h1>
          
          <h2>Militares sorteados:</h2>
          
          <div class="soldiers" th:each="i : ${#numbers.sequence(0, sessionDraw.justiceCouncil.councilSize - 1)}">
            <div th:with="soldier=${sessionDraw.soldiers[i]}">
              <input type="hidden" class="sdId" disabled="disabled" name="sdReplace" th:value="${soldier.id}">
              
              <button class="replaceSoldier" type="button" title="substituir" th:attr="data-sid=${soldier.id}">
                <img th:src="@{/images/refresh.svg}">
              </button>
              
              <button type="button" class="accordion" 
                th:text="${soldier.name} + ' ' + ${soldier.impedimentStatusAsText}"
                th:classappend="${soldier.hasImpediment() ? 'highlight-impediment' : ''}"></button>
              
              <div class="panel">
                <div class="sdInfo">
                  <div>
                    <label>Organização Militar</label><br />
                    <span th:text="${soldier.omAliasAndName}"></span>
                  </div>
                  
                  <div>
                    <label>Posto</label><br />
                    <span th:text="${soldier.militaryRank.name}"></span>
                  </div>
                  
                   <br/><br/>
                                  
                  <div>
                    <label>E-mail</label><br />
                    <span th:text="${soldier.email}"></span>
                  </div>
                  
                  <div>
                    <label>Telefone</label><br />
                    <span th:text="${soldier.phone}"></span>
                  </div>
                </div>
                
                <br/><br/><br/>
                
                <div class="impediment" th:each="exclusion : ${soldier.customExclusions}">
                  <div class="impediment-header">
                    <span th:text="${exclusion.periodAsText}"></span>
                  </div>
                  
                  <p th:text="${exclusion.message}"></p><br/>
                </div>
              </div>
            </div>
          </div>
          
          <div class="cancelDraw" th:if="${!editMode}">
            <a th:href="@{/mngmt/dw/home(complete=true)}" onclick="return confirmationAction()">cancelar sorteio</a>
          </div>
        </div>
        
        <br/>
        <div style="overflow:auto;width: 100%;">
          <div style="float:right;">
            <button type="button" id="prevBtn" class="app-gray-btn" onclick="nextPrev(-1)">Voltar</button>
            <button type="button" id="nextBtn" class="app-green-btn" onclick="nextPrev(1)">Próximo</button>
          </div>
        </div>
        
        <div style="text-align:center;margin-top:40px">
          <span class="step" th:if="${!editMode}"></span>
          <span class="step"></span>
          <span class="step" th:if="${!#lists.isEmpty(sessionDraw.soldiers)}"></span>
        </div>
      </form>
    </div>

    <script layout:fragment="page-script" th:inline="javascript">
	  
	  const drawForm = document.getElementById("drawForm");
	  const soldiersDiv = document.getElementsByClassName("soldiers");
	  const tabsDiv = document.getElementsByClassName("tab");
	  const councilSelect = document.querySelector('#councilSelect');
	  const armySelect = document.querySelector('#armySelect');
	  const quarterSelect = document.querySelector('#quarterSelect');
	  
	  const HOME_URL = '[(@{/mngmt/dw/home})]';
	  const RAND_ALL_URL = '[(@{/mngmt/dw/sdrand/all})]';
	  const COUNCIL_TYPE = '[(${sessionDraw.councilType})]';
	  const GET = 'get';
	  
	  
	  let currentTab = setCurrentTab();
	  
	  setListenersOnCfgSelectElements();
	  
	  showRankSequence();
	  
	  showErrorsIfExists();
	  
	  showSuccessMsgIfExists();
	  
      setSubmitOptions();
	  
      setReplaceSoldierListeners();
      
      showTab(currentTab);
      
      accordion(document.getElementsByClassName("accordion"));
	  
      
      function setCurrentTab(){
    	  return hasDrawnSoldiers() ? tabsDiv.length - 1 : 0;  
      }
      
      function hasDrawnSoldiers(){
    	  return soldiersDiv.length > 0;
      }
      
      function hasTab1(){
    	  return document.querySelector('.tab1') != null;
      }
      
      function setListenersOnCfgSelectElements(){
    	  if (hasTab1() === false)
    		  return;
    	  
    	  councilSelect.addEventListener('change', submitFormChanges);
    	  
    	  armySelect.addEventListener('change', submitFormChanges);
    	  
    	  quarterSelect != null ? quarterSelect.addEventListener('change', submitFormChanges) : '';	
      }
      
	  function submitFormChanges(){
		drawForm.action = HOME_URL;
		drawForm.method = GET;
		drawForm.submit();
	  }
	  
	  function showRankSequence(){
		  if (COUNCIL_TYPE == 'CPJ'){
  		  	let ranks = document.querySelectorAll('div.ranks');
  		      
            for (let i = 0; i < ranks.length; i++){
    			let span = document.createElement("span");
    			span.className = 'sequence';
    			
    			let text = (i + 1) + '.';
    			text += (COUNCIL_TYPE === 'CPJ' && i == 1) ? '(suplente)' : '';
    			
    			span.textContent = text;
    			
    			ranks[i].insertBefore(span, ranks[i].firstChild);
            }
		  }
	  }
	  
	  function showSuccessMsgIfExists(){
        const successMsg = '[(${successMsg})]';
        const imgSrc = '[(@{/images/check-light.svg})]';
        let tab1 = document.querySelector('.tab1');
        
        console.log(successMsg);
        if (successMsg){
        	let div = document.createElement('div');
        	div.className = 'successMsg';
        	
        	let img = document.createElement('img');
        	img.src = imgSrc;
        	
        	let span = document.createElement('span');
        	span.textContent = successMsg;
        	
        	div.append(img);
        	div.append(span);
        	
        	tab1.insertBefore(div, tab1.firstChild);
        }
	  }
	  
	  function showErrorsIfExists(){
		  showAnnualQuarterErrors();
		  showRanksErrors();
	  }
	  
	  function showAnnualQuarterErrors(){
		  if (hasTab1() === false)
    		  return;
    	  
		  if (COUNCIL_TYPE == 'CPJ'){
    		  let fieldError = "[(${#fields.errors('${sessionDraw.annualQuarter}')})]";
    		  
    		  let errorSpan = document.createElement('span');
    		  errorSpan.className = 'error';
    		  
    		  const annualQuarterDiv = document.querySelector('div#annualQuarter');
    		  errorSpan.textContent = fieldError.replace("[]", "");
    		  annualQuarterDiv.insertBefore(errorSpan, annualQuarterDiv.children[2]);
		  }
	  }
	  
	  function showRanksErrors(){
		  let fieldError = "[(${#fields.errors('${sessionDraw.ranks}')})]";
		  fieldError += "[(${#fields.errors('${sessionDraw.soldiers}')})]";
		  fieldError += "[(${soldierError})]";
		  
		  let errorSpan = document.createElement('span');
		  errorSpan.className = 'error';
		  
		  const ranksDiv = document.querySelector('div#ranks');
		  errorSpan.textContent = fieldError.replaceAll('[', '').replaceAll(']', '');
		  ranksDiv.insertBefore(errorSpan, ranksDiv.children[2]);
		  
		  if(errorSpan.textContent){
			  if (hasTab1())
			  	currentTab = 1;
			  else
				currentTab = 0;
		  }
	  }
      
	  //if has drawn soldiers set action to save endpoint otherwise set action to draw all endpoint
      function setSubmitOptions(){
    	  drawForm.action = RAND_ALL_URL;
		  finishFormBtnName = 'Sortear todos';
		  
    	  if (hasDrawnSoldiers()){
    		  drawForm.action = '[(@{/mngmt/dw/save})]';
    		  drawForm.method = 'post';
    		  finishFormBtnName = 'Salvar sorteio';
    	  }
      }
      
      function setReplaceSoldierListeners(){
    	  const replaceSoldierBtns = document.querySelectorAll('button.replaceSoldier');
    	  
    	  for (let i = 0; i < replaceSoldierBtns.length; i++){
    		  replaceSoldierBtns[i].addEventListener('click', function(){
    			  let ranksSelect = document.querySelectorAll("select.ranks")[i];
    			  let rankId = ranksSelect.options[ranksSelect.selectedIndex].value;
    			  location.href = '[(@{/mngmt/dw/sdrand/replace/})]' + rankId + "/" + replaceSoldierBtns[i].dataset.sid;
    		  });
    	  }
      }
      
      function confirmationAction(){
    		if (hasDrawnSoldiers())
    			if (!window.confirm("A lista atual não foi salva. Esta ação irá apagar todos os militares sorteados até o momento. Deseja prosseguir?"))
    				return false
    		return true;
    	}
    </script>
  </body>
</html>